<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verbaly ‚Äì Assemblea</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#007bff" />

  <!-- 1) Firebase SDK compat: App e Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- Se in futuro serve anche Firestore/Storage, aggiungere qui:
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  -->

  <!-- 2) Configurazione Firebase personalizzata -->
  <script src="./firebaseConfig.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    button, input[type="file"], input, textarea, select {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer; /* Manina su tutti i pulsanti e select */
    }
    /* Stili per l‚Äôarchivio con altezza fissa e cursore di scorrimento */
    #archiveList {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background: #fff;
    }
    #transcript {
      width: 100%;
      min-height: 200px;
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      resize: vertical;
      overflow: auto;
    }
    #privacyBlock, #mainApp, #archiveIcon {
      display: none;
    }
    #loginSection {
      max-width: 350px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 6px;
    }
    #loginSection input, #loginSection button {
      width: 90%;
      margin: 5px 0;
    }
    #loginMessage {
      color: red;
      min-height: 1.2em;
    }
    #calendarSection input, #calendarSection textarea {
      display: block;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <!-- Login via Firebase -->
  <div id="loginSection">
    <h2>Login / Registrazione</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Registrati</button>
    <p id="loginMessage"></p>
    <p><small>Verifica l‚Äôemail dopo la registrazione prima di fare login.</small></p>
  </div>

  <!-- Applicazione principale: nascosta fino al login -->
  <div id="mainApp">
    <h1>Verbaly ‚Äì Registrazione Assemblea</h1>

    <!-- Pulsante Programma Assemblea -->
    <button onclick="toggleCalendar()" id="calendarBtn" style="display:none;">üìÖ Programma Assemblea</button>

    <!-- Sezione Voci / Interventi -->
    <div id="speakerSection" style="margin-bottom: 15px;">
      <input type="text" id="newSpeaker" placeholder="Inserisci nome voce (es. Amministratore)" />
      <button onclick="addSpeaker()">Aggiungi Voce</button>
      <select id="speakerSelect">
        <!-- Voci inserite dinamicamente -->
      </select>
      <button onclick="changeSpeaker()" id="changeSpeakerBtn" style="display:none;">Cambia Voce</button>
    </div>

    <!-- Controlli Registrazione -->
    <button onclick="startRecording()" id="recordBtn">Registra</button>
    <button onclick="stopRecording()" id="stopBtn" disabled>Ferma</button>
    <button onclick="downloadTranscript()" id="downloadBtn">Scarica Verbale</button>
    <button onclick="clearTranscript()">Pulisci Verbale</button><br>

    <label>üìé Allega documenti: <input type="file" id="attachments" multiple /></label>
    <div id="transcript" contenteditable="true">Qui apparir√† la trascrizione...</div>

    <div id="privacyBlock">
      <h2>Informativa Privacy</h2>
      <p>Ai sensi del Regolamento UE 2016/679 (GDPR), i partecipanti sono informati che l‚Äôassemblea √® registrata al solo fine della redazione del verbale. I dati non saranno diffusi e saranno trattati esclusivamente ai fini condominiali.</p>
      <p>Il presente verbale conterr√† trascrizioni fedeli delle dichiarazioni rilasciate nel corso dell‚Äôassemblea e potr√† essere conservato per scopi legittimi e conformi alla normativa vigente.</p>
    </div>

    <div id="archiveIcon" ondblclick="toggleArchive()">üìÅ Archivio Assemblee</div>
    <div id="archiveList"></div>

    <button onclick="toggleVoting()" id="voteBtn" style="display:none;">üó≥Ô∏è Nuova Votazione</button>
    <div id="votingSection" style="display:none; border:1px solid #ccc; padding:10px; margin-top:10px;">
      <h3>Nuova Votazione</h3>
      <input type="text" id="voteQuestion" placeholder="Domanda della votazione" /><br />
      <input type="text" id="option1" placeholder="Opzione 1" />
      <input type="text" id="option2" placeholder="Opzione 2" /><br />
      <button onclick="launchVoting()" id="launchBtn">Avvia Votazione</button>
      <button onclick="castVote()" id="castBtn" style="display:none;">Vota</button>
      <button onclick="reportVote()" id="reportBtn" style="display:none;">Report Votazione</button>
      <div id="voteResults"></div>
    </div>

    <div id="calendarSection" style="display:none; border:1px solid #ccc; padding:10px; margin-top:10px;">
      <h3>Nuovo Programma Assemblea</h3>
      <input type="text" id="title" placeholder="Titolo Assemblea" /><br />
      <input type="datetime-local" id="datetime" /><br />
      <input type="text" id="location" placeholder="Luogo" /><br />
      <textarea id="notes" placeholder="Note" rows="3" cols="30"></textarea><br />
      <button onclick="saveMeeting()">Salva Assemblea</button>
      <div id="calendarList"></div>
    </div>

    <!-- Logout -->
    <button id="logoutBtn" style="margin-top:20px;">Logout</button>
  </div>

  <script>
    // ================================
    // 1) Gestione Login via Firebase
    // ================================
    const loginSection  = document.getElementById('loginSection');
    const mainApp       = document.getElementById('mainApp');
    const loginBtn      = document.getElementById('loginBtn');
    const registerBtn   = document.getElementById('registerBtn');
    const logoutBtn     = document.getElementById('logoutBtn');
    const loginMessage  = document.getElementById('loginMessage');

    // Mostra/nasconde sezioni in base allo stato utente
    auth.onAuthStateChanged(user => {
      if (user && user.emailVerified) {
        loginSection.style.display = 'none';
        mainApp.style.display      = 'block';
        // Se √® la prima volta, mostra pulsanti admin
        document.getElementById('calendarBtn').style.display = 'inline-block';
        document.getElementById('voteBtn').style.display     = 'inline-block';
      } else {
        loginSection.style.display = 'block';
        mainApp.style.display      = 'none';
      }
    });

    // Login con email/password
    loginBtn.onclick = () => {
      const email = document.getElementById('email').value.trim();
      const pwd   = document.getElementById('password').value.trim();
      if (!email || !pwd) {
        loginMessage.innerText = "Inserisci email e password.";
        return;
      }
      auth.signInWithEmailAndPassword(email, pwd)
        .then(() => {
          const user = auth.currentUser;
          if (!user.emailVerified) {
            loginMessage.innerText = "Verifica il tuo indirizzo email prima di continuare.";
            auth.signOut();
          }
        })
        .catch(err => {
          loginMessage.innerText = err.message;
        });
    };

    // Registrazione con invio email verifica
    registerBtn.onclick = () => {
      const email = document.getElementById('email').value.trim();
      const pwd   = document.getElementById('password').value.trim();
      if (!email || !pwd) {
        loginMessage.innerText = "Inserisci email e password.";
        return;
      }
      auth.createUserWithEmailAndPassword(email, pwd)
        .then(cred => {
          cred.user.sendEmailVerification()
            .then(() => {
              loginMessage.style.color = 'green';
              loginMessage.innerText = "Email di verifica inviata. Controlla la posta.";
            });
        })
        .catch(err => {
          loginMessage.innerText = err.message;
        });
    };

    // Logout
    logoutBtn.onclick = () => {
      auth.signOut();
    };


    // ====================================
    // 2) MainApp: Trascrizione, Votazioni,
    //    Archiviazione, Programma Assemblea
    // ====================================
    let hasSaved = false;
    let currentQuestion = "";
    let currentOpt1 = "";
    let currentOpt2 = "";
    let currentResults = {};
    let sessionVotazioni = [];
    let speakers = [];

    // Speech Recognition
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'it-IT';
    recognition.continuous = true;

    recognition.onresult = function(event) {
      const transcriptText = event.results[event.results.length - 1][0].transcript;
      const timestamp = new Date().toLocaleTimeString();
      const speaker = document.getElementById("speakerSelect").value || "Voce Sconosciuta";
      document.getElementById("transcript").innerText += `\n[${timestamp}] ${speaker}: ${transcriptText}`;
    };

    function addSpeaker(prefill) {
      const input = document.getElementById("newSpeaker");
      const name = prefill || input.value.trim();
      if (!name) return;
      if (!speakers.includes(name)) {
        speakers.push(name);
        const select = document.getElementById("speakerSelect");
        const option = document.createElement("option");
        option.value = name;
        option.innerText = name;
        select.appendChild(option);
        if (!prefill) {
          select.value = name;
        }
      }
      if (!prefill) input.value = "";
    }

    function changeSpeaker() {
      recognition.stop();
      recognition.start();
    }

    function startRecording() {
      if (!document.getElementById("speakerSelect").value) {
        alert("Seleziona o aggiungi una voce prima di registrare.");
        return;
      }
      recognition.start();
      document.getElementById("stopBtn").disabled = false;
      document.getElementById("recordBtn").disabled = true;
      document.getElementById("changeSpeakerBtn").style.display = 'inline-block';
    }

    function stopRecording() {
      recognition.stop();
      document.getElementById("stopBtn").disabled = true;
      document.getElementById("recordBtn").disabled = false;
      document.getElementById("changeSpeakerBtn").style.display = 'none';
    }

    function toggleVoting() {
      const section = document.getElementById("votingSection");
      section.style.display = section.style.display === "none" ? "block" : "none";
    }

    function launchVoting() {
      currentQuestion = document.getElementById("voteQuestion").value.trim();
      currentOpt1 = document.getElementById("option1").value.trim();
      currentOpt2 = document.getElementById("option2").value.trim();
      if (!currentQuestion || !currentOpt1 || !currentOpt2) {
        alert("Inserisci domanda e due opzioni per la votazione.");
        return;
      }
      currentResults = {};
      currentResults[currentOpt1] = 0;
      currentResults[currentOpt2] = 0;
      document.getElementById("castBtn").style.display = 'inline-block';
      document.getElementById("reportBtn").style.display = 'inline-block';
      document.getElementById("launchBtn").disabled = true;
      updateVoteResultsDisplay();
    }

    function castVote() {
      const response = confirm(
        `${currentQuestion}\n` +
        `1. ${currentOpt1}\n` +
        `2. ${currentOpt2}\n` +
        `OK per "${currentOpt1}", Annulla per "${currentOpt2}"`
      );
      const chosen = response ? currentOpt1 : currentOpt2;
      currentResults[chosen] = (currentResults[chosen] || 0) + 1;
      updateVoteResultsDisplay();
    }

    function updateVoteResultsDisplay() {
      let html = `<h4>Votazione: ${currentQuestion}</h4>`;
      html += `<div>${currentOpt1}: ${currentResults[currentOpt1] || 0} voti</div>`;
      html += `<div>${currentOpt2}: ${currentResults[currentOpt2] || 0} voti</div>`;
      document.getElementById("voteResults").innerHTML = html;
    }

    function reportVote() {
      if (!currentQuestion) {
        alert("Nessuna votazione attiva da riportare.");
        return;
      }
      const votes1 = currentResults[currentOpt1] || 0;
      const votes2 = currentResults[currentOpt2] || 0;
      const total = votes1 + votes2;
      let txt = `\nRisultato votazione: ${currentQuestion}\n`;
      txt += `${currentOpt1}: ${votes1} voti\n`;
      txt += `${currentOpt2}: ${votes2} voti\n`;
      txt += `Totale votanti: ${total}\n----------------------------\n`;
      document.getElementById("transcript").innerText += txt;

      sessionVotazioni.push({
        question: currentQuestion,
        option1: currentOpt1,
        option2: currentOpt2,
        counts: { [currentOpt1]: votes1, [currentOpt2]: votes2 }
      });

      currentQuestion = "";
      currentOpt1 = "";
      currentOpt2 = "";
      currentResults = {};
      document.getElementById("voteQuestion").value = "";
      document.getElementById("option1").value = "";
      document.getElementById("option2").value = "";
      document.getElementById("voteResults").innerHTML = "";
      document.getElementById("castBtn").style.display = 'none';
      document.getElementById("reportBtn").style.display = 'none';
      document.getElementById("launchBtn").disabled = false;
    }

    function downloadTranscript() {
      if (hasSaved) {
        alert("Hai gi√† salvato questo verbale.");
        return;
      }
      const progTitle = document.getElementById("title").value.trim();
      const progDatetime = document.getElementById("datetime").value;
      const progLocation = document.getElementById("location").value.trim();
      const progNotes = document.getElementById("notes").value.trim();

      let header = "";
      if (progTitle || progDatetime || progLocation || progNotes) {
        header += "Programma Assemblea:\n";
        if (progTitle)   header += `Titolo: ${progTitle}\n`;
        if (progDatetime) header += `Data: ${new Date(progDatetime).toLocaleString()}\n`;
        if (progLocation) header += `Luogo: ${progLocation}\n`;
        if (progNotes)    header += `Note: ${progNotes}\n`;
        header += "\n";
      }

      const privacy = document.getElementById("privacyBlock").innerText;
      const transcript = document.getElementById("transcript").innerText;

      let summary = "";
      if (sessionVotazioni.length) {
        summary += "\nReport completo votazioni:\n";
        sessionVotazioni.forEach((v, i) => {
          const votes1 = v.counts[v.option1] || 0;
          const votes2 = v.counts[v.option2] || 0;
          const total = votes1 + votes2;
          summary += `\nVotazione ${i + 1}: ${v.question}\n`;
          summary += `${v.option1}: ${votes1} voti\n`;
          summary += `${v.option2}: ${votes2} voti\n`;
          summary += `Totale votanti: ${total}\n`;
        });
      }

      const fullText = `${header}${privacy}\n\n${transcript}${summary}`;
      const blob = new Blob([fullText], { type: "application/msword" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Verbale_Assemblea.doc";
      a.click();
      URL.revokeObjectURL(url);

      const record = {
        timestamp: new Date().toISOString(),
        content: transcript,
        program: {
          title: progTitle,
          datetime: progDatetime,
          location: progLocation,
          notes: progNotes
        },
        votazioni: sessionVotazioni.slice(),
        speakers: speakers.slice()
      };
      let history = JSON.parse(localStorage.getItem("verbalyHistory")) || [];
      history.push(record);
      localStorage.setItem("verbalyHistory", JSON.stringify(history));
      hasSaved = true;
    }

    function downloadArchivedTranscript(index) {
      const recordHistory = JSON.parse(localStorage.getItem("verbalyHistory")) || [];
      const record = recordHistory[index];
      if (!record) {
        alert("Record non trovato");
        return;
      }
      let header = "";
      if (record.program) {
        const p = record.program;
        header += "Programma Assemblea:\n";
        if (p.title)    header += `Titolo: ${p.title}\n`;
        if (p.datetime) header += `Data: ${new Date(p.datetime).toLocaleString()}\n`;
        if (p.location) header += `Luogo: ${p.location}\n`;
        if (p.notes)    header += `Note: ${p.notes}\n`;
        header += "\n";
      }

      const privacy = document.getElementById("privacyBlock").innerText;
      const content = record.content;

      let summary = "";
      if (record.votazioni && record.votazioni.length) {
        summary += "\nReport completo votazioni:\n";
        record.votazioni.forEach((v, i) => {
          const votes1 = v.counts[v.option1] || 0;
          const votes2 = v.counts[v.option2] || 0;
          const total = votes1 + votes2;
          summary += `\nVotazione ${i + 1}: ${v.question}\n`;
          summary += `${v.option1}: ${votes1} voti\n`;
          summary += `${v.option2}: ${votes2} voti\n`;
          summary += `Totale votanti: ${total}\n`;
        });
      }

      const fullText = `${header}${privacy}\n\n${content}${summary}`;
      const blob = new Blob([fullText], { type: "application/msword" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Verbale_Assemblea_${record.timestamp}.doc`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleArchive() {
      const div = document.getElementById("archiveList");
      const currentDisplay = div.style.display;
      if (currentDisplay === "block") {
        div.style.display = "none";
        return;
      }
      const history = JSON.parse(localStorage.getItem("verbalyHistory")) || [];
      let html = "<h3>Storico Verbali:</h3>";
      history.forEach((item, index) => {
        html += `<div><strong>${item.timestamp}</strong>\n`;
        html += `<pre>${item.content}</pre>\n`;
        html += `<button onclick="downloadArchivedTranscript(${index})">üì• Scarica Verbale</button> `;
        html += `<button onclick="deleteVerbale(${index})">üóëÔ∏è Elimina</button></div><hr>`;
      });
      div.innerHTML = html;
      div.style.display = "block";
      setTimeout(() => {
        div.scrollTop = div.scrollHeight;
      }, 0);
    }

    function deleteVerbale(index) {
      let history = JSON.parse(localStorage.getItem("verbalyHistory")) || [];
      history.splice(index, 1);
      localStorage.setItem("verbalyHistory", JSON.stringify(history));
      toggleArchive(); toggleArchive();
    }

    function clearTranscript() {
      document.getElementById("transcript").innerText = "Qui apparir√† la trascrizione...";
      hasSaved = false;
      sessionVotazioni = [];
      currentQuestion = ""; currentOpt1 = ""; currentOpt2 = ""; currentResults = {};
      document.getElementById("voteResults").innerHTML = "";
      document.getElementById("launchBtn").disabled = false;
      document.getElementById("castBtn").style.display = 'none';
      document.getElementById("reportBtn").style.display = 'none';
    }

    function toggleCalendar() {
      const section = document.getElementById("calendarSection");
      section.style.display = section.style.display === "none" ? "block" : "none";
      displayMeetings();
    }

    function saveMeeting() {
      const title = document.getElementById("title").value.trim();
      const datetime = document.getElementById("datetime").value;
      const location = document.getElementById("location").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const meeting = { title, datetime, location, notes };
      const meetings = JSON.parse(localStorage.getItem("verbalyMeetings") || "[]");
      meetings.push(meeting);
      localStorage.setItem("verbalyMeetings", JSON.stringify(meetings));
      displayMeetings();
    }

    function displayMeetings() {
      const list = document.getElementById("calendarList");
      const meetings = JSON.parse(localStorage.getItem("verbalyMeetings") || "[]");
      let html = "<h3>Assemblee Programmate:</h3>";
      meetings.forEach((m, i) => {
        html += `<div><strong>${m.title}</strong><br>${new Date(m.datetime).toLocaleString()} - ${m.location}<br>${m.notes}<br>`;
        html += `<button onclick="deleteMeeting(${i})">Elimina</button></div><hr>`;
      });
      list.innerHTML = html;
    }

    function deleteMeeting(index) {
      const meetings = JSON.parse(localStorage.getItem("verbalyMeetings") || "[]");
      meetings.splice(index, 1);
      localStorage.setItem("verbalyMeetings", JSON.stringify(meetings));
      displayMeetings();
    }
  </script>

  <!-- Registrazione Service Worker (PWA) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registrato con successo'))
        .catch(error => console.warn('SW registration failed:', error));
    }
  </script>
</body>
</html>
